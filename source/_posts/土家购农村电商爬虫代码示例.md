---
title: 土家购农村电商爬虫代码示例
date: 2017-05-12 15:46:44
author: Peter pan
categories: Python 爬虫 农村电商
tags: 无框架原生爬虫
---


网络爬虫
<!--more-->

首先在pycharm这个IDE中写爬虫的主体部分:

```python
#爬取链接和信息的部分
from bs4 import BeautifulSoup
import requests
import time
import pymongo
import random

#连接本地数据库并创建两个表
client = pymongo.MongoClient('localhost', 27017)
tujiagou = client['tujiagou']
url_list = tujiagou['url_list']
item_info = tujiagou['item_info']

start_url = 'http://www.tujiago.com/'

headers = {
    'User-Agent':'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.96 Safari/537.36',
    'Cookie':'store_id=0; vary=staticdad85da5caa9112672513bb15a0d7952; UM_distinctid=15bf1838e3c153-064bb97bcefed4-153d655c-384000-15bf1838e3db2b; S[FIRST_REFER]=%7B%22ID%22%3A%22%22%2C%22REFER%22%3A%22https%3A%2F%2Fwww.google.co.jp%2F%22%2C%22DATE%22%3A1494404751000%7D; s=587fac54ade2a1a79d1a27819bdee8db; page_load_times=4; NTKF_T2D_CLIENTID=guestECE58596-E636-C47B-9C38-F1838DDD3CAE; nTalk_CACHE_DATA={uid:kf_9332_ISME9754_guestECE58596-E636-C4,tid:1494405582300579}; S[NOW_REFER]=%7B%22ID%22%3A%22%22%2C%22REFER%22%3A%22https%3A%2F%2Fwww.google.co.jp%2F%22%2C%22DATE%22%3A1494404751000%7D; S[N]=97FE7B11-7578-20E1-30BD-997B69666C35; CNZZDATA1259313336=1399165820-1494405492-null%7C1494405492',
    'Referer':'https://www.google.co.jp/'
}

def get_links_from(channel):
    list_view = channel
    wb_data = requests.get(list_view,headers=headers)
    soup = BeautifulSoup(wb_data.text, 'lxml')
    for link in soup.select('.ui-page-num > a'):
            item_link = link.get('href')
            get_links_from_links(item_link)

def get_links_from_links(channel):
    list_view = channel
    wb_data = requests.get(list_view, headers=headers)
    soup = BeautifulSoup(wb_data.text, 'lxml')
    for item_link in soup.select('a.entry-title'):
        item_link = start_url + item_link.get('href')
        time.sleep(1)
        get_item_info_from(item_link)

def get_item_info_from(url,data=None):
    wb_data = requests.get(url,headers=headers)
    if wb_data.status_code == 404:
        pass
    else:
        try:
            soup = BeautifulSoup(wb_data.text, 'lxml')
            data = {
                'title':soup.title.text.strip(),
                'price':soup.select('em.goodsprice')[0].text.strip(),
                'area': soup.select('span.tb-deliveryAdd.deliveryAddModi')[0].text.strip(),
                'view':list(soup.select('em.color_3355aa.evaluation')[0].stripped_strings),
                'url':url
            }
        except IndexError:
            pass
        except AttributeError:
            pass
        print(data)
        if data:
            item_info.insert_one(data)
```
```python
#主函数部分
from multiprocessing import Pool
from page_parsing import get_item_info_from,get_links_from_links,get_links_from
from channel_extracting import channel_list

if __name__ == '__main__':
    pool = Pool(processes=6)
    pool.map(get_links_from,channel_list.split())
    pool.close()
    pool.join()
```

```python
#爬取主页面链接
import requests
from bs4 import BeautifulSoup

start_url = 'http://www.tujiago.com/'
def get_index_url(url):
    wb_data = requests.get(url)
    soup = BeautifulSoup(wb_data.text, 'lxml')
    links = soup.select('p.category-1 > a')
    for link in links:
        page_url = start_url + link.get('href')
        print(page_url)

#get_index_url(start_url)

channel_list = '''
http://www.tujiago.com//index.php/gallery-656.html
http://www.tujiago.com//index.php/gallery-797.html
http://www.tujiago.com//index.php/gallery-699.html
http://www.tujiago.com//index.php/gallery-769.html
http://www.tujiago.com//index.php/gallery-689.html
http://www.tujiago.com//index.php/gallery-949.html
'''
```
```python
#在jupyter notebook中的操作
import pymongo
import charts

client = pymongo.MongoClient('localhost', 27017)
tujiagou = client['tujiagou']
url_list = tujiagou['url_list']
item_info = tujiagou['item_info']

def data_gen():
    for i in item_info.find({},{'price':1,'view':1,'title':1}).limit(6):
        data = {
            'name': i['title'],
            'data': [int(i['view'][0])],
            'type': 'column'
        }
        yield data
        
series = [i for i in data_gen()]
options = {
    'chart'   : {'zoomType':'xy'},
    'title'   : {'text': '土家购浏览量与价钱的关系'},
    'subtitle': {'text': '柱状图分析'},
    'yAxis'   : {'title': {'text': '浏览量'}},
    'xAxis'   : {'categories': ['商品类别']},
    }

charts.plot(series,options=options,show='inline')
```

最后会生成如下的图表效果：

![](http://omg5mjb8v.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-05-12%20%E4%B8%8B%E5%8D%883.53.00.png)